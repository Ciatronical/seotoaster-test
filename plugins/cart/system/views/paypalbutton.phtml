<?php
	
	//Integration der Paypalkundendaten in die Datenbank 
	//wird nachdem dem Zahlungsvorgang ausgefÃ¼hrt
					
					if(isset($_GET["full_name"])){
					
					$fullname=$_GET["full_name"];
					$email=$_GET["email"];
					
					
					echo "<script>";					
					
					echo"var name='$fullname';";
					
					echo "console.log(name);";	
					
					echo "</script>";
					
					$pdo = new PDO('mysql:host=localhost;dbname=seotoaster', 'root', 'windossa5one');
					
						$sql  = 'SELECT * FROM `user` WHERE `full_name`="'.$fullname.'"';
				
					
					
				$count=0;
					foreach ($pdo->query($sql) as $row) 
					{	$count++;
						echo "<script>";	
   					echo "var row='$row[email]';";
   					echo "console.log(row);";
   					echo "</script>";	
   					
					}
				if(!$count){
				
				$sql  = 'INSERT INTO `user` (`id`, `role_id`, `password`, `email`, `full_name`, `last_login`, `ipaddress`, `reg_date`, `referer`, `gplus_profile`, `mobile_phone`, `notes`) VALUES (NULL, \'member\', NULL, "'.$email.'", "'.$fullname.'", CURRENT_TIMESTAMP, NULL, NULL, NULL, NULL, NULL, NULL)';					
					
						$pdo->query($sql);
				
				}
					
								   
						
						
											
					
					
				   
					//header('Location: http://localhost/thank-you.html'); 
									
				
				   }else{

					echo "<script>";
					
					//echo "console.log('Fehler');";	
					
					echo "</script>";				
								   
				   }
				   
				
								
						
					?>
	
<!-- Paypal Express button script -->	

<div id="paypal-button"></div>

<script src="https://www.paypalobjects.com/api/checkout.js"></script>


<div id="paypal-button-container"></div>

    <script>
    

    
       <?php
       
			
       
         $price=$this->summary['total']; //Total Price for Payment
        
			echo"var price='$price';";
			

			
		?>
		


        paypal.Button.render({
        	
   


            env: 'sandbox', // sandbox | production

            // PayPal Client IDs - replace with your own
            // Create a PayPal app: https://developer.paypal.com/developer/applications/create
            client: {
                sandbox:    'AVWwnmz32wlzFqogw9E93H82FlVYWvMUXohxKnITuIlMJDwQCGge8_nqRI-iMxNmPktOG1DRgmHTfpUK',
                production: '<insert production client id>'
            },

            // Show the buyer a 'Pay Now' button in the checkout flow
            commit: true,

            // payment() is called when the button is clicked
            payment: function(data, actions) {

                // Make a call to the REST api to create the payment
                return actions.payment.create({
                    payment: {
                        transactions: [
                            {
                                amount: { total: price, currency: 'EUR' }
                            }
                        ]
                    }
                });
            },

            // onAuthorize() is called when the buyer approves the payment
            onAuthorize: function(data, actions) {
            
            
            
          
            return actions.payment.get().then(function(paymentDetails) {
            
          
            

                // Make a call to the REST api to execute the payment
                return actions.payment.execute().then(function() {
              
             
             //Paypal Kundendaten 
             var firstname=paymentDetails.payer.payer_info.first_name;
				 var lastname=paymentDetails.payer.payer_info.last_name;
				 var email=paymentDetails.payer.payer_info.email;
				 
				 var street=paymentDetails.payer.payer_info.shipping_address.line1;
				 var city=paymentDetails.payer.payer_info.shipping_address.city;
				 var postalCode=paymentDetails.payer.payer_info.shipping_address.postal_code;
				 
				 
				 
  
  	
					//console.log(paymentDetails.payer.payer_info.shipping_address);
                    window.alert("Zahlung erfolgreich");
                    
                    
				
                    
                    
                   //Senden der Kundendaten an Server 
                   window.location = "http://localhost/checkout.html?full_name="+firstname+" "+lastname+"&email="+email+"&street="+street+"&city="+city+"&postalCode="+postalCode;
                });
           });
           
            }

        }, '#paypal-button-container');

    </script>
	
	
</div>




